<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>任务提交模块测试</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn-primary {
            background-color: #007bff;
            color: white;
        }
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>任务提交模块测试</h1>
        <div id="test-results"></div>
        
        <div class="test-section">
            <h3>测试操作</h3>
            <button class="btn-primary" onclick="checkTaskSubmission()">检查任务提交模块</button>
            <button class="btn-secondary" onclick="checkDataManager()">检查数据管理器</button>
            <button class="btn-primary" onclick="checkElements()">检查页面元素</button>
            <button class="btn-secondary" onclick="testFileUpload()">测试文件上传</button>
        </div>
        
        <div class="test-section">
            <h3>模拟任务提交</h3>
            <div class="form-group">
                <label>测试员工：</label>
                <select id="test-employee">
                    <option value="">选择员工</option>
                </select>
            </div>
            <div class="form-group">
                <label>测试任务：</label>
                <select id="test-task">
                    <option value="">选择任务</option>
                </select>
            </div>
            <div class="form-group">
                <label>完成说明：</label>
                <textarea id="test-note" rows="3" placeholder="输入完成说明"></textarea>
            </div>
            <div class="form-group">
                <label>测试文件：</label>
                <input type="file" id="test-file" multiple>
            </div>
            <button class="btn-primary" onclick="simulateSubmission()">模拟提交</button>
        </div>
    </div>

    <script src="未命名.js"></script>
    <script>
        function addResult(message, type = 'success') {
            const results = document.getElementById('test-results');
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.innerHTML = `${new Date().toLocaleTimeString()}: ${message}`;
            results.appendChild(div);
        }

        function checkTaskSubmission() {
            addResult('开始检查任务提交模块...', 'warning');
            
            // 检查TaskSubmission对象
            if (typeof TaskSubmission === 'undefined') {
                addResult('❌ TaskSubmission 对象未定义', 'error');
                return;
            }
            addResult('✅ TaskSubmission 对象已定义', 'success');
            
            // 检查方法
            const methods = ['init', 'bindEvents', 'loadEmployees', 'loadEmployeeTasks', 'submitTask'];
            methods.forEach(method => {
                if (typeof TaskSubmission[method] === 'function') {
                    addResult(`✅ ${method} 方法存在`, 'success');
                } else {
                    addResult(`❌ ${method} 方法不存在`, 'error');
                }
            });
            
            // 检查元素
            const elements = [
                'task-submission',
                'task-submission-form',
                'submission-employee',
                'submission-task',
                'submission-attachment',
                'submission-note',
                'submission-uploaded-files'
            ];
            
            elements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    addResult(`✅ ${id} 元素存在`, 'success');
                } else {
                    addResult(`❌ ${id} 元素不存在`, 'error');
                }
            });
        }

        function checkDataManager() {
            addResult('检查数据管理器...', 'warning');
            
            if (typeof DataManager === 'undefined') {
                addResult('❌ DataManager 未定义', 'error');
                return;
            }
            
            try {
                const employees = DataManager.getEmployees();
                const tasks = DataManager.getTasks();
                
                addResult(`✅ 员工数量: ${employees.length}`, 'success');
                addResult(`✅ 任务数量: ${tasks.length}`, 'success');
                
                if (employees.length > 0) {
                    const select = document.getElementById('test-employee');
                    select.innerHTML = '<option value="">选择员工</option>';
                    employees.forEach(emp => {
                        const option = document.createElement('option');
                        option.value = emp.id;
                        option.textContent = `${emp.name} (${emp.department})`;
                        select.appendChild(option);
                    });
                    addResult('✅ 员工数据已加载到测试选择框', 'success');
                }
            } catch (error) {
                addResult(`❌ 数据管理器错误: ${error.message}`, 'error');
            }
        }

        function checkElements() {
            addResult('检查页面元素状态...', 'warning');
            
            const taskSubmission = document.getElementById('task-submission');
            if (taskSubmission) {
                addResult(`✅ task-submission 元素存在, display: ${window.getComputedStyle(taskSubmission).display}`, 'success');
                addResult(`✅ task-submission 类名: ${taskSubmission.className}`, 'success');
                
                // 检查是否激活
                if (taskSubmission.classList.contains('active')) {
                    addResult('✅ task-submission 模块已激活', 'success');
                } else {
                    addResult('⚠️ task-submission 模块未激活', 'warning');
                }
            } else {
                addResult('❌ task-submission 元素不存在', 'error');
            }
        }

        function testFileUpload() {
            addResult('测试文件上传功能...', 'warning');
            
            const fileInput = document.getElementById('submission-attachment');
            if (fileInput) {
                addResult('✅ 文件输入元素存在', 'success');
                
                // 创建测试文件
                const testFile = new File(['测试内容'], 'test.txt', { type: 'text/plain' });
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(testFile);
                fileInput.files = dataTransfer.files;
                
                // 触发change事件
                const event = new Event('change', { bubbles: true });
                fileInput.dispatchEvent(event);
                
                addResult('✅ 文件上传事件已触发', 'success');
            } else {
                addResult('❌ 文件输入元素不存在', 'error');
            }
        }

        function simulateSubmission() {
            const employeeId = document.getElementById('test-employee').value;
            const taskId = document.getElementById('test-task').value;
            const note = document.getElementById('test-note').value;
            const files = document.getElementById('test-file').files;
            
            if (!employeeId || !taskId || !note) {
                addResult('❌ 请填写完整的测试数据', 'error');
                return;
            }
            
            addResult('开始模拟任务提交...', 'warning');
            
            try {
                // 模拟TaskSubmission的提交逻辑
                const tasks = DataManager.getTasks();
                const taskIndex = tasks.findIndex(t => t.id === taskId);
                
                if (taskIndex !== -1) {
                    tasks[taskIndex].status = 'done';
                    tasks[taskIndex].completionNote = note;
                    tasks[taskIndex].completedAt = new Date().toISOString();
                    
                    DataManager.saveTasks(tasks);
                    
                    addResult('✅ 任务提交成功！', 'success');
                    addResult(`✅ 任务状态已更新为: done`, 'success');
                    addResult(`✅ 完成说明: ${note}`, 'success');
                    
                    // 重置测试表单
                    document.getElementById('test-task').value = '';
                    document.getElementById('test-note').value = '';
                    document.getElementById('test-file').value = '';
                } else {
                    addResult('❌ 未找到指定任务', 'error');
                }
            } catch (error) {
                addResult(`❌ 提交失败: ${error.message}`, 'error');
            }
        }

        // 页面加载完成后自动检查
        window.addEventListener('load', () => {
            setTimeout(() => {
                addResult('页面加载完成，开始自动检查...', 'warning');
                checkTaskSubmission();
                checkDataManager();
                checkElements();
            }, 1000);
        });
    </script>
</body>
</html>